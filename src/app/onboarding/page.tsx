// üìÅ /src/app/onboarding/page.tsx
/**
 * @page Onboarding Premium - VERSI√ìN DEFINITIVA
 * @version 14.0.0 - CORREGIDO: Tipos espec√≠ficos por paso
 */

'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { cn } from '@/lib/utils';

import { Button } from '@/components/ui/button';

// Importar tipos espec√≠ficos de cada paso
import { EnhancedStep1Location, type EnhancedLocationData } from '@/components/onboarding/steps/EnhancedStep1Location';
import { EnhancedStep2Story, type EnhancedStoryData, type Certification } from '@/components/onboarding/steps/EnhancedStep2Story';
import { EnhancedStep3Visual, type EnhancedVisualData } from '@/components/onboarding/steps/EnhancedStep3Visual';
import { EnhancedStep4Capacity, type EnhancedCapacityData } from '@/components/onboarding/steps/EnhancedStep4Capacity';
import { EnhancedStep5Documents, type EnhancedStep5DocumentsData } from '@/components/onboarding/steps/EnhancedStep5Documents';
import { EnhancedStep6Stripe, type EnhancedStep6StripeData } from '@/components/onboarding/steps/EnhancedStep6Stripe';

import {
  MapPin,
  BookOpen,
  Camera,
  Package,
  FileText,
  CreditCard,
  ChevronLeft,
  ChevronRight,
  ArrowRight,
  CheckCircle,
  Clock,
  Sparkles,
  Shield,
  Leaf
} from 'lucide-react';

// ============================================================================
// CONFIGURACI√ìN DE PASOS
// ============================================================================

const STEPS = [
  {
    id: 1,
    title: 'Ubicaci√≥n',
    icon: MapPin,
    color: 'text-origen-pradera',
    bgColor: 'bg-origen-pradera/10',
    time: '2 min',
    description: 'Direcci√≥n, provincia y categor√≠as',
    longDescription: 'Cu√©ntanos d√≥nde est√° ubicado tu negocio y qu√© productos vendes.'
  },
  {
    id: 2,
    title: 'Historia',
    icon: BookOpen,
    color: 'text-origen-hoja',
    bgColor: 'bg-origen-hoja/10',
    time: '3 min',
    description: 'Nombre, descripci√≥n y valores',
    longDescription: 'Comparte la historia detr√°s de tus productos y los valores de tu marca.'
  },
  {
    id: 3,
    title: 'Perfil visual',
    icon: Camera,
    color: 'text-origen-pino',
    bgColor: 'bg-origen-pino/10',
    time: '2 min',
    description: 'Logo, banner y fotos',
    longDescription: 'Configura la imagen de tu perfil y muestra tus productos.'
  },
  {
    id: 4,
    title: 'Capacidad',
    icon: Package,
    color: 'text-origen-bosque',
    bgColor: 'bg-origen-bosque/10',
    time: '2 min',
    description: 'Producci√≥n y env√≠os',
    longDescription: 'Define tu capacidad de producci√≥n y las opciones de env√≠o.'
  },
  {
    id: 5,
    title: 'Documentaci√≥n',
    icon: FileText,
    color: 'text-origen-oscuro',
    bgColor: 'bg-origen-oscuro/10',
    time: '3 min',
    description: 'Verificaci√≥n de identidad',
    longDescription: 'Verifica tu identidad como productor y sube tus certificaciones.'
  },
  {
    id: 6,
    title: 'Pagos',
    icon: CreditCard,
    color: 'text-origen-pradera',
    bgColor: 'bg-origen-pradera/10',
    time: '2 min',
    description: 'Conectar Stripe',
    longDescription: 'Configura Stripe para recibir pagos de forma segura.'
  }
];

// ============================================================================
// TIPOS ESPEC√çFICOS PARA CADA PASO
// ============================================================================

interface OnboardingFormData {
  step1: EnhancedLocationData;
  step2: EnhancedStoryData;
  step3: EnhancedVisualData;
  step4: EnhancedCapacityData;
  step5: EnhancedStep5DocumentsData;
  step6: EnhancedStep6StripeData;
}

// ============================================================================
// COMPONENTE PRINCIPAL
// ============================================================================

export default function OnboardingPage() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState(0);
  const [direction, setDirection] = useState(0);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isValid, setIsValid] = useState(true);

  // Estado con tipos espec√≠ficos por paso
  const [formData, setFormData] = useState<OnboardingFormData>({
    step1: { 
      address: '', 
      city: '', 
      province: '', 
      postalCode: '', 
      categories: [], 
      locationImages: [],
      foundedYear: undefined,
      teamSize: undefined
    },
    step2: { 
      businessName: '', 
      tagline: '', 
      description: '', 
      values: [], 
      photos: [],
      productionPhilosophy: '',
      certifications: []
    },
    step3: { 
      logo: null, 
      banner: null, 
      productImages: [],
      introVideo: ''
    },
    step4: {
      productionCapacity: { daily: 50 },
      deliveryOptions: [],
      deliveryAreas: [],
      minOrderAmount: 20,
      sustainablePackaging: false,
      packagingDescription: ''
    },
    step5: {
      cif: undefined,
      seguroRC: undefined,
      manipuladorAlimentos: undefined,
      certifications: [],
      verificationStatus: 'pending'
    },
    step6: {
      stripeConnected: false,
      acceptTerms: false
    }
  });

  const totalSteps = STEPS.length;
  const progress = ((currentStep + 1) / totalSteps) * 100;

  // ========================================================================
  // MANEJADORES DE NAVEGACI√ìN
  // ========================================================================
  
  const handleNext = () => {
    if (currentStep < totalSteps - 1) {
      setDirection(1);
      setCurrentStep(currentStep + 1);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setDirection(-1);
      setCurrentStep(currentStep - 1);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const handleStepClick = (index: number) => {
    if (index <= currentStep) {
      setDirection(index > currentStep ? 1 : -1);
      setCurrentStep(index);
    }
  };

  const handleComplete = async () => {
    setIsSubmitting(true);
    try {
      // Aqu√≠ ir√≠a la llamada a la API para guardar todos los datos
      await new Promise(resolve => setTimeout(resolve, 2000));
      router.push('/dashboard');
    } catch (error) {
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // ========================================================================
  // MANEJADORES DE CAMBIO POR PASO (TIPADOS)
  // ========================================================================
  
  const handleStep1Change = (data: EnhancedLocationData) => {
    setFormData(prev => ({ ...prev, step1: data }));
  };

  const handleStep2Change = (data: EnhancedStoryData) => {
    setFormData(prev => ({ ...prev, step2: data }));
  };

  const handleStep3Change = (data: EnhancedVisualData) => {
    setFormData(prev => ({ ...prev, step3: data }));
  };

  const handleStep4Change = (data: EnhancedCapacityData) => {
    setFormData(prev => ({ ...prev, step4: data }));
  };

  const handleStep5Change = (data: EnhancedStep5DocumentsData) => {
    setFormData(prev => ({ ...prev, step5: data }));
  };

  const handleStep6Change = (data: EnhancedStep6StripeData) => {
    setFormData(prev => ({ ...prev, step6: data }));
  };

  // ========================================================================
  // RENDER DEL PASO ACTUAL
  // ========================================================================
  
  const renderStep = () => {
    switch (currentStep) {
      case 0:
        return (
          <EnhancedStep1Location
            data={formData.step1}
            onChange={handleStep1Change}
          />
        );
      case 1:
        return (
          <EnhancedStep2Story
            data={formData.step2}
            onChange={handleStep2Change}
          />
        );
      case 2:
        return (
          <EnhancedStep3Visual
            data={formData.step3}
            onChange={handleStep3Change}
          />
        );
      case 3:
        return (
          <EnhancedStep4Capacity
            data={formData.step4}
            onChange={handleStep4Change}
          />
        );
      case 4:
        return (
          <EnhancedStep5Documents
            data={formData.step5}
            onChange={handleStep5Change}
            selectedCertifications={formData.step2.certifications?.map(c => ({
              id: c.id,
              name: c.name,
              issuingBody: c.issuingBody
            })) || []}
          />
        );
      case 5:
        return (
          <EnhancedStep6Stripe
            data={formData.step6}
            onChange={handleStep6Change}
          />
        );
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-origen-crema/30">
      
      {/* ====================================================================
          HEADER - Ultra minimal
      ==================================================================== */}
      <header className="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-sm border-b border-gray-100">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <Link href="/" className="flex items-center">
              <div className="w-9 h-9 rounded-lg bg-gradient-to-br from-origen-bosque to-origen-pino flex items-center justify-center shadow-sm">
                <svg className="w-5 h-5 text-white" viewBox="0 0 200 200">
                  <circle cx="100" cy="100" r="85" fill="none" stroke="white" strokeWidth="3"/>
                  <path d="M100 140 L100 80" stroke="white" strokeWidth="5" strokeLinecap="round"/>
                  <path d="M100 90 Q85 75, 75 65" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round"/>
                  <path d="M100 90 Q115 75, 125 65" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round"/>
                  <circle cx="100" cy="140" r="8" fill="white"/>
                  <circle cx="100" cy="140" r="5" fill="#74C69D"/>
                </svg>
              </div>
            </Link>
            
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500">
                {currentStep + 1}/{totalSteps}
              </span>
              <div className="w-20 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-origen-pradera rounded-full transition-all duration-500"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* ====================================================================
          MAIN - Layout: Timeline vertical (4) + Formulario (8)
      ==================================================================== */}
      <main className="max-w-7xl mx-auto px-6 py-10 lg:py-12">
        <div className="flex flex-col lg:flex-row gap-10 lg:gap-16">
          
          {/* ====================================================================
              COLUMNA IZQUIERDA - Timeline vertical (4/12)
          ==================================================================== */}
          <div className="lg:w-4/12">
            <div className="sticky top-24 space-y-6">
              
              {/* T√≠tulo de la secci√≥n */}
              <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
                <Sparkles className="w-4 h-4 text-origen-pradera" />
                <h2 className="text-xs font-bold text-origen-bosque uppercase tracking-wider">
                  Configura tu tienda
                </h2>
              </div>
              
              {/* Timeline vertical */}
              <div className="relative">
                {STEPS.map((step, index) => {
                  const isActive = index === currentStep;
                  const isCompleted = index < currentStep;
                  const isPending = index > currentStep;
                  const Icon = step.icon;
                  
                  return (
                    <div key={step.id} className="relative flex gap-4 pb-8 last:pb-0">
                      
                      {/* L√≠nea conectora vertical */}
                      {index < totalSteps - 1 && (
                        <div 
                          className={cn(
                            "absolute left-5 top-10 w-0.5 h-[calc(100%-1.5rem)]",
                            index < currentStep 
                              ? "bg-gradient-to-b from-origen-pradera to-origen-pradera/40" 
                              : "bg-gray-200"
                          )}
                        />
                      )}
                      
                      {/* Indicador del paso */}
                      <div className="relative z-10 flex-shrink-0">
                        <div className={cn(
                          "w-10 h-10 rounded-full flex items-center justify-center transition-all",
                          isCompleted && "bg-origen-pradera text-white shadow-sm",
                          isActive && "bg-white border-2 shadow-sm",
                          isActive && `border-${step.color.replace('text-', '')}`,
                          isPending && "bg-gray-100 border border-gray-200 text-gray-400",
                          !isActive && !isCompleted && !isPending && "bg-white border-2 border-gray-200 text-gray-500"
                        )}>
                          {isCompleted ? (
                            <CheckCircle className="w-5 h-5" />
                          ) : (
                            <Icon className={cn("w-5 h-5", isActive && step.color)} />
                          )}
                        </div>
                        
                        {/* Badge de tiempo */}
                        <span className={cn(
                          "absolute -bottom-2 -right-2 text-[10px] font-medium px-1.5 py-0.5 rounded-full shadow-sm",
                          isCompleted 
                            ? "bg-green-100 text-green-700 border border-green-200" 
                            : "bg-white text-gray-600 border border-gray-200"
                        )}>
                          {step.time}
                        </span>
                      </div>
                      
                      {/* Contenido del paso */}
                      <div 
                        onClick={() => handleStepClick(index)}
                        className={cn(
                          "flex-1 pt-1 transition-all",
                          isPending && "opacity-50 cursor-not-allowed",
                          !isPending && "cursor-pointer"
                        )}
                      >
                        <div className="flex items-center justify-between">
                          <h3 className={cn(
                            "text-sm font-semibold",
                            isActive && "text-origen-bosque",
                            isCompleted && "text-origen-oscuro",
                            isPending && "text-gray-500"
                          )}>
                            {step.title}
                          </h3>
                          
                          {/* Indicador de estado */}
                          {isActive && (
                            <span className="text-[10px] font-medium text-origen-pradera flex items-center gap-1">
                              <span className="w-1.5 h-1.5 rounded-full bg-origen-pradera animate-pulse" />
                              En progreso
                            </span>
                          )}
                          {isCompleted && (
                            <span className="text-[10px] font-medium text-green-600 flex items-center gap-1">
                              <CheckCircle className="w-3 h-3" />
                              Listo
                            </span>
                          )}
                        </div>
                        
                        <p className="text-xs text-gray-600 mt-1 line-clamp-1">
                          {step.description}
                        </p>
                        
                        {/* Descripci√≥n larga - solo paso activo */}
                        {isActive && (
                          <p className="text-xs text-gray-500 mt-2 italic">
                            {step.longDescription}
                          </p>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
              
              {/* Tiempo total estimado */}
              <div className="mt-4 bg-white/50 rounded-xl border border-gray-100 p-4">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 rounded-lg bg-origen-pradera/5 flex items-center justify-center">
                    <Clock className="w-4 h-4 text-origen-pradera" />
                  </div>
                  <div>
                    <p className="text-xs text-gray-500">Tiempo total</p>
                    <p className="text-sm font-semibold text-origen-bosque">~14 minutos</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* ====================================================================
              COLUMNA DERECHA - Formulario (8/12)
          ==================================================================== */}
          <div className="lg:w-8/12">
            
            {/* T√≠tulo del paso actual */}
            <div className="mb-6 pb-4 border-b border-gray-100">
              <div className="flex items-center gap-2 mb-1">
                <div className={cn(
                  "w-6 h-6 rounded-md flex items-center justify-center",
                  STEPS[currentStep].bgColor
                )}>
                  {(() => {
                    const Icon = STEPS[currentStep].icon;
                    return <Icon className={cn("w-3.5 h-3.5", STEPS[currentStep].color)} />;
                  })()}
                </div>
                <span className="text-xs font-medium text-gray-500">
                  Paso {currentStep + 1} de {totalSteps}
                </span>
              </div>
              <h1 className="text-2xl lg:text-3xl font-bold text-origen-bosque">
                {STEPS[currentStep].title}
              </h1>
            </div>

            {/* Contenido del paso - ANIMADO */}
            <AnimatePresence mode="wait" custom={direction}>
              <motion.div
                key={currentStep}
                custom={direction}
                initial={{ opacity: 0, x: direction > 0 ? 20 : -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: direction > 0 ? -20 : 20 }}
                transition={{ duration: 0.25, ease: 'easeInOut' }}
              >
                {renderStep()}
              </motion.div>
            </AnimatePresence>

            {/* ====================================================================
                NAVEGACI√ìN - Botones en una l√≠nea
            ==================================================================== */}
            <div className="flex items-center justify-between mt-10 pt-6 border-t border-gray-200">
              
              {/* Trust badges */}
              <div className="flex items-center gap-3 text-xs text-gray-400">
                <div className="flex items-center gap-1">
                  <Shield className="w-3.5 h-3.5" />
                  <span className="hidden sm:inline">SSL</span>
                </div>
                <div className="flex items-center gap-1">
                  <Leaf className="w-3.5 h-3.5" />
                  <span className="hidden sm:inline">Km 0</span>
                </div>
              </div>

              {/* Botones */}
              <div className="flex items-center gap-3">
                {currentStep > 0 && (
                  <Button
                    variant="outline"
                    onClick={handleBack}
                    disabled={isSubmitting}
                    className="h-10 px-4 border-gray-300 text-origen-bosque hover:bg-origen-crema/50 hover:border-origen-pradera"
                  >
                    Anterior
                  </Button>
                )}

                {currentStep < totalSteps - 1 ? (
                  <Button
                    onClick={handleNext}
                    disabled={!isValid || isSubmitting}
                    className="h-10 px-5 bg-origen-bosque hover:bg-origen-pino text-white shadow-sm hover:shadow transition-all"
                  >
                    Continuar
                  </Button>
                ) : (
                  <Button
                    onClick={handleComplete}
                    disabled={!isValid || isSubmitting}
                    className="h-10 px-5 bg-origen-bosque hover:bg-origen-pino text-white shadow-sm hover:shadow transition-all"
                  >
                    {isSubmitting ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                        Completando...
                      </>
                    ) : (
                      <>
                        Finalizar
                      </>
                    )}
                  </Button>
                )}
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}